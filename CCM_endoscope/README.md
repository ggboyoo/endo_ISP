### 颜色矫正矩阵（CCM）计算工具

本工具用于从一张拍摄的 24 色卡（Macbeth ColorChecker Classic，6x4）图像中计算颜色矫正矩阵（CCM）。支持 3x3 线性模型或带偏置的 3x4 仿射模型，支持 sRGB 线性化、手动 ROI 框选、网格采样与 DeltaE 评估。

#### 安装依赖

```bash
pip install -r requirements.txt
```

#### 使用方法

```bash
python tools/ccm_calculator.py <你的色卡图片路径> \
  --roi "x,y,w,h" \
  --cell_margin 0.15 \
  --model affine3x4 \
  --lambda 0.0
```

- **ROI（推荐）**：使用 `--roi x,y,w,h` 指定色卡区域；若不提供，程序会弹出交互窗口让你用鼠标框选 ROI（按空格/回车确认）。
- **cell_margin**：每个色块内部边缘留白比例（0~0.45），防止采到边缘阴影或印刷边框。
- **model**：`linear3x3` 或 `affine3x4`（带偏置项，通常拟合更好）。
- **--lambda**：Tikhonov 正则强度，默认 0，可适当 >0 提升稳健性。
- 默认会做 sRGB 线性化，如要关闭，传 `--no_linearize`。

运行后会在同目录生成 `*_ccm.json`，包含矩阵、统计、DeltaE 等信息。

#### ROI 建议

- 让 ROI 尽可能只包含色卡区域（含外黑边亦可），且在图中保持近似正对，避免大透视畸变。

#### 输出示例

JSON 中 `matrix` 的行对应输出通道（R、G、B）。对 `affine3x4`：每行 4 个系数（含偏置）。

```json
{
  "model": "affine3x4",
  "matrix": [
    [1.0421, -0.0112, -0.0309, 0.0054],
    [-0.0524, 1.0641, -0.0117, 0.0048],
    [0.0067, -0.0432, 1.0365, 0.0021]
  ],
  "deltaE_after_stats": {"mean": 1.23, "median": 1.10, "max": 3.21, "min": 0.42}
}
```

#### 常见问答

- **是否需要 RAW？** 不必须。若是 sRGB JPEG，保持默认"线性化后解算"。RAW/线性数据可关闭 `--no_linearize`。
- **目标参考是什么？** 采用 D65 下的 Macbeth 24 色卡 sRGB 参考（BabelColor 数据）。
- **如何应用矩阵？**
  - 线性 3x3：`rgb_out = rgb_in @ M3x3^T`
  - 仿射 3x4：`rgb_out = concat(rgb_in, 1) @ M3x4^T`
  - 若输入/输出用于显示，需在 sRGB 与线性之间做相应的 gamma 转换。

#### 暗矫正对比工具

如果发现暗矫正后图像变亮，可使用对比工具分析：

```bash
python CCM_endoscope/tools/compare_dark_correction.py \
  --original "原始图像.raw" \
  --dark "暗参考.raw" \
  --output_dir "对比结果"
```

该工具会：
- 对比暗矫正前后的统计信息（均值、标准差等）
- 自动检测异常情况（如图像变亮）
- 保存对比图像和差异图
- 分析暗参考图像的有效性

#### Lens Shading 中值滤波

Lens shading程序现在支持对网格均值进行中值滤波，以去除异常值：

```python
# 在lens_shading.py中配置
ENABLE_MEDIAN_FILTER = True  # 启用中值滤波
MEDIAN_FILTER_SIZE = 3       # 滤波核大小（3x3或5x5）
```

- **作用**：去除网格分析中的异常值，提高矫正矩阵的稳定性
- **原理**：对每个网格的均值进行中值滤波，保持边缘信息的同时去除噪声
- **效果**：减少因个别异常网格导致的矫正系数突变

#### Lens Shading 算法原理详解

**1. 网格矫正矩阵计算**：
```
网格分析 → 计算每个网格平均亮度 → 以中心为参考计算矫正系数
```

- 将图像分成多个网格（如16x16像素）
- 计算每个网格的平均亮度
- 矫正系数 = 中心网格亮度 / 当前网格亮度
- 中心区域矫正系数 = 1.0，边缘区域矫正系数 > 1.0

**2. 插值扩展到全图像**：
```
网格矩阵(135x240) → 三次样条插值 → 全尺寸矩阵(2160x3840)
```

- 使用`RectBivariateSpline`进行三次样条插值
- 创建平滑的矫正系数过渡
- 每个像素都有对应的矫正系数

**3. 为什么会出现小于1的值**：
- **插值平滑**：三次样条插值需要平滑连接网格点，可能产生略小于1的过渡值
- **数学特性**：插值函数在连接不同值时会产生中间值
- **实际影响**：这些值通常接近1.0（如0.98-1.02），不会显著影响图像质量
- **矫正公式**：`corrected_pixel = original_pixel × correction_coefficient`

**4. 矫正效果**：
- 系数 > 1.0：使像素变亮（边缘区域，原本较暗）
- 系数 = 1.0：不改变（中心区域，参考点）
- 系数 < 1.0：使像素变暗（插值过渡区域，通常接近1.0）


